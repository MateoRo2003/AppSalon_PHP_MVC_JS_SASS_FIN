const citaAdmin={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){generarHorarios(),gestionarModalObservaciones(),mostrarHorariosCrear()}function ConfirmarHoraCrear(){calcularFinalizacionPrevista();const e=document.getElementById("fecha-nueva"),a=document.getElementById("hora-nueva"),t=document.getElementById("hora-prevista");citaAdmin.fecha&&citaAdmin.hora&&(e.value=citaAdmin.fecha,a.value=citaAdmin.hora,t.value=citaAdmin.finalizacionPrevista),CerrarHoraCrear(),cerrarCrearCita()}function cerrarModalAnular(){document.querySelector("#modal-observaciones-anular").style.display="none"}function eliminarCita(e){const a=e.getAttribute("data-id"),t=e.getAttribute("data-usuario-id"),o=e.getAttribute("data-email");console.log("el email",o),citaAdmin.usuarioId=t,citaAdmin.email=o,console.log(citaAdmin.usuarioId),console.log(citaAdmin.email),citaAdmin.id=a,console.log("ID de la cita a posponer: "+citaAdmin.id);const n=document.querySelector("#modal-observaciones-anular");n.style.display="block",n.classList.add("show"),setTimeout((()=>{n.style.animation="slideIn 0.5s forwards"}),10)}function AnularTurno(e){const a=citaAdmin.usuarioId,t=citaAdmin.id,o=citaAdmin.email;console.log("Longitud de la observación: ",e.length),console.log("email: ",o),console.log("cita: ",t),console.log("usuario: ",a);const n=document.getElementById("loading-spinner");n.classList.add("show"),e.length>=15&&t&&o?fetch("/api/anularCita",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({citaid:t,email:o,usuarioId:a,observacion:e})}).then((e=>e.text())).then((e=>{console.log("Respuesta cruda del servidor:",e);try{const a=JSON.parse(e);a.resultado?(n.classList.remove("show"),Swal.fire({icon:"success",title:"Cita Anulada",text:"La cita fue anulada correctamente.",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):alert("Hubo un problema al anular la cita: "+(a.error||"Error desconocido"))}catch(e){console.error("Error al parsear JSON:",e),alert("Hubo un error al procesar la respuesta del servidor")}})).catch((e=>{console.error("Error al enviar los datos:",e),alert("Hubo un error al enviar los datos al servidor")})):alert("Por favor, ingresa una observación válida de al menos 15 caracteres.")}var calendarVer,calendarDisponible,calendarPosponer;function inicializarCalendarioVer(){var e=document.getElementById("calendar-ver"),a=document.getElementById("fecha"),t=document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var o=new Date;o.setHours(0,0,0,0),new Date(o).setDate(o.getDate()+30);var n=new Date(o),r=new Date(o);r.setDate(o.getDate()+30);var i=new Date(o);i.setMonth(o.getMonth()+1),i.setDate(1),calendar=new FullCalendar.calendarVer(e,{locale:"es",initialView:"dayGridMonth",initialDate:o,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:n,end:r},dateClick:function(e){var o=new Date(e.dateStr);if(o.setHours(0,0,0,0),o<n||o>r)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const i=o.getUTCDay();[6].includes(i)||(e.dayEl.classList.add("selected"),a.value=e.dateStr,cita.fecha=e.dateStr,ConsultarHorariosAdmin(cita.fecha),t.style.display="block",t.classList.add("mostrar"),setTimeout((()=>{t.style.animation="slideIn 0.5s forwards"}),10),t.style.pointerEvents="auto"),[6].includes(i)&&(a.value="")},dayCellDidMount:function(e){var a=new Date(e.date);a.setHours(0,0,0,0),(a<n||a>r)&&e.el.classList.add("disabled-day"),a.getTime()===o.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const a=e.start.getMonth(),t=e.start.getFullYear(),n=new Date(o);n.setMonth(o.getMonth()+1),n.setFullYear(o.getFullYear());new Date(t,a,1);const r=a===o.getMonth()&&t===o.getFullYear(),i=a===n.getMonth()&&t===n.getFullYear();document.querySelector(".fc-prev-button").disabled=r;document.querySelector(".fc-next-button").disabled=i}}),calendarVer.render()}function cerrarhorarioscrear(){const e=document.getElementById("modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("mostrar"),modal.style.pointerEvents="auto",e.style.pointerEvents="none"}),500)}function cerrarCrearCita(){document.getElementById("modal-crearcita").style.display="none",document.getElementById("blur-background").style.display="none"}function VerCrearCita(){const e=document.getElementById("modal-crearcita");e.classList.add("show"),e.style.display="block",inicializarFechas(),setTimeout((function(){calendarDisponible?(console.log("hola"),calendarDisponible.updateSize()):console.error("calendarAdmin no está inicializado.")}),300)}function inicializarFechas(){var e=document.getElementById("calendar-crear"),a=document.getElementById("fechacrear"),t=document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var o=new Date;o.setHours(0,0,0,0),new Date(o).setDate(o.getDate()+30);var n=new Date(o),r=new Date(o);r.setDate(o.getDate()+30);var i=new Date(o);i.setMonth(o.getMonth()+1),i.setDate(1),(calendarDisponible=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",initialDate:o,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:n,end:r},dateClick:function(e){var o=new Date(e.dateStr);if(o.setHours(0,0,0,0),o<n||o>r)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const i=o.getUTCDay();[6].includes(i)||(e.dayEl.classList.add("selected"),a.value=e.dateStr,citaAdmin.fecha=e.dateStr,ConsultarHorariosAdmin(citaAdmin.fecha),t.style.display="block",t.classList.add("mostrar"),setTimeout((()=>{t.style.animation="slideIn 0.5s forwards"}),10),t.style.pointerEvents="auto"),[6].includes(i)&&(a.value="")},dayCellDidMount:function(e){var a=new Date(e.date);a.setHours(0,0,0,0),(a<n||a>r)&&e.el.classList.add("disabled-day"),a.getTime()===o.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){}})).render()}function posponerCita(e){const a=e.getAttribute("data-email"),t=e.getAttribute("data-usuario-id"),o=e.getAttribute("data-id"),n=e.getAttribute("data-hora"),r=e.getAttribute("data-finalizacion"),i=parseInt(e.getAttribute("data-duracion-total"),10);console.log("ID de la cita a posponer: "+o),console.log("Hora de la cita:",n),console.log("Finalización prevista:",r),console.log("Duración Total en minutos:",i),citaAdmin.email=a,citaAdmin.usuarioId=t,citaAdmin.id=o,citaAdmin.HoraOriginal="No disponible"!==n?moment(n,"HH:mm").format("HH:mm"):null,citaAdmin.finalizacion="No disponible"!==r?moment(r,"HH:mm").format("HH:mm"):null,citaAdmin.duracionTotal=i,console.log("Hora original guardada:",citaAdmin.HoraOriginal),console.log("Hora de finalización guardada:",citaAdmin.finalizacion),console.log("Duración Total guardada (en minutos):",citaAdmin.duracionTotal);const l=document.getElementById("modal-posponer");l.classList.add("show"),l.style.display="block";const c=l.querySelector("#hora-posponer"),s=l.querySelector("#finalizacion-posponer");c&&s&&(c.textContent=citaAdmin.HoraOriginal?citaAdmin.HoraOriginal:"No disponible",s.textContent=citaAdmin.finalizacion?citaAdmin.finalizacion:"No disponible"),inicializarCalendarioPosponer(o),setTimeout((function(){calendar3?(console.log("Hola"),calendar3.updateSize()):console.error("calendarAdmin no está inicializado.")}),300)}function cerrarModalFecha(){document.getElementById("modal-posponer").style.display="none",document.getElementById("blur-background").style.display="none"}function cerrarModalHora(){document.getElementById("modal-seleccionar-turno").style.display="none",document.getElementById("blur-background").style.display="none"}function inicializarCalendarioPosponer(){var e=document.getElementById("calendar-posponer"),a=document.getElementById("fechaPosponer"),t=document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var o=new Date;o.setHours(0,0,0,0),new Date(o).setDate(o.getDate()+30);var n=new Date(o),r=new Date(o);r.setDate(o.getDate()+30);var i=new Date(o);i.setMonth(o.getMonth()+1),i.setDate(1),(calendarPosponer=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",initialDate:o,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:n,end:r},dateClick:function(e){var o=new Date(e.dateStr);if(o.setHours(0,0,0,0),o<n||o>r)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const i=o.getUTCDay();[6].includes(i)||(e.dayEl.classList.add("selected"),a.value=e.dateStr,citaAdmin.fecha=e.dateStr,ConsultarHorariosAdmin(citaAdmin.fecha),t.style.display="block",t.classList.add("mostrar"),setTimeout((()=>{t.style.animation="slideIn 0.5s forwards"}),10),t.style.pointerEvents="auto"),[6].includes(i)&&(a.value="")},dayCellDidMount:function(e){var a=new Date(e.date);a.setHours(0,0,0,0),(a<n||a>r)&&e.el.classList.add("disabled-day"),a.getTime()===o.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const a=e.start.getMonth(),t=e.start.getFullYear(),n=new Date(o);n.setMonth(o.getMonth()+1),n.setFullYear(o.getFullYear());new Date(t,a,1);const r=a===o.getMonth()&&t===o.getFullYear(),i=a===n.getMonth()&&t===n.getFullYear();document.querySelector(".fc-prev-button").disabled=r;document.querySelector(".fc-next-button").disabled=i}})).render()}function ConsultarHorariosAdmin(e){e?fetch("/api/consultarHorarios",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:e})}).then((e=>e.json())).then((e=>{e.error?alert("Error: "+e.error):(horariosOcupados=e.map((e=>({horaInicio:e.hora?e.hora.slice(0,5):"",horaFin:e.finalizacion?e.finalizacion.slice(0,5):"",estado:parseInt(e.estado,10)}))),console.log("Horarios ocupados:",horariosOcupados))})).catch((e=>{console.error("Error al obtener los horarios:",e)})):console.error("No se ha seleccionado una fecha válida.")}function CerrarHoraCrear(){const e=document.querySelector("#modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("show")}),500)}function cerrarmodalhorarios(){const e=document.getElementById("modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("mostrar"),modal.style.pointerEvents="auto",e.style.pointerEvents="none"}),500)}function generarHorarios(e,a,t){let o=[],n=moment(e,"HH:mm"),r=moment(a,"HH:mm");for(;n<=r;)o.push(n.format("HH:mm")),n.add(t,"minutes");return o}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()})),document.querySelector("#observacion-anular").addEventListener("input",(function(){const e=document.querySelector("#observacion-anular"),a=document.querySelector("#enviar-observacion-anular");e.value.length>15?a.disabled=!1:a.disabled=!0})),document.querySelector("#enviar-observacion-anular").addEventListener("click",(function(){AnularTurno(document.querySelector("#observacion-anular").value)}));const duracionTotal=document.getElementById("duracionTotal").value;function mostrarHorariosCrear(e){const a=document.querySelector("#horarios-crear");a.innerHTML="",a.style.display="block";let t=[];const o=document.querySelector("#turno-manana"),n=document.querySelector("#turno-tarde");let r;"manana"===e?(t=generarHorarios("08:00","11:30",30),o.classList.add("seleccionado"),n.classList.remove("seleccionado"),r=moment("12:00","HH:mm")):(t=generarHorarios("14:00","18:30",30),n.classList.add("seleccionado"),o.classList.remove("seleccionado"),r=moment("19:00","HH:mm"));const i=citaAdmin?citaAdmin.duracionTotal:30;console.log(i,"duración total"),t.forEach(((t,o)=>{const n=document.createElement("button");n.classList.add("botones","horario","botones-horarios"),n.textContent=t;const l=moment(t,"HH:mm"),c=moment(t,"HH:mm").add(i,"minutes");if(c.isAfter(r))return n.setAttribute("disabled","true"),void(n.style.backgroundColor="#ccc");!horariosOcupados.some((({horaInicio:e,horaFin:a,estado:t})=>{if(2===t)return!1;const o=moment(e,"HH:mm"),n=moment(a,"HH:mm");return l.isBetween(o,n,null,"[)")||c.isBetween(o,n,null,"(]")||l.isBefore(o)&&c.isAfter(n)}))?(n.addEventListener("click",(()=>seleccionarHoraCrear(t))),n.style.backgroundColor="manana"===e?"#28a745":"#ff9800"):(n.setAttribute("disabled","true"),n.style.backgroundColor="#ccc"),setTimeout((()=>{n.classList.add("visible")}),100*o),a.appendChild(n)}))}function seleccionarHoraCrear(e){const a=document.querySelectorAll(".horario"),t=document.querySelector("#confirmar-modal-crear");a.forEach((e=>e.classList.remove("seleccionado")));const o=Array.from(a).find((a=>a.textContent===e));o?(o.classList.add("seleccionado"),citaAdmin.hora=e,console.log(citaAdmin.hora),t.disabled=!1):(citaAdmin.hora=null,t.disabled=!0),calcularFinalizacionPrevista()}function calcularFinalizacionPrevista(){if(console.log("Calculando la finalización prevista...: ",citaAdmin.duracionTotal),!citaAdmin.hora||!citaAdmin.duracionTotal)return void console.warn("Faltan datos para calcular la finalización prevista.");let[e,a]=citaAdmin.hora.split(":").map(Number),t=new Date(citaAdmin.fecha+"T"+citaAdmin.hora+":00");t.setMinutes(t.getMinutes()+citaAdmin.duracionTotal);let o=t.getHours(),n=t.getMinutes();n%30!=0&&(n=30*Math.ceil(n/30),60===n&&(n=0,o+=1));let r=o.toString().padStart(2,"0"),i=n.toString().padStart(2,"0");citaAdmin.finalizacionPrevista=`${r}:${i}`,console.log("Finalización prevista redondeada:",citaAdmin.finalizacionPrevista)}function mostrarHorariosPosponer(e){const a=document.querySelector("#horarios-posponer");a.innerHTML="",a.style.display="block";let t=[];const o=document.querySelector("#turno-manana"),n=document.querySelector("#turno-tarde");let r;"manana"===e?(t=generarHorarios("08:00","11:30",30),o.classList.add("seleccionado"),n.classList.remove("seleccionado"),r=moment("12:00","HH:mm")):(t=generarHorarios("14:00","18:30",30),n.classList.add("seleccionado"),o.classList.remove("seleccionado"),r=moment("19:00","HH:mm"));const i=citaAdmin.duracionTotal;console.log("Duración total de la cita:",i),t.forEach(((t,o)=>{const n=document.createElement("BUTTON");n.classList.add("botones","horario","botones-horarios"),n.textContent=t;const l=moment(t,"HH:mm"),c=moment(t,"HH:mm").add(i,"minutes");if(c.isAfter(r))return n.setAttribute("disabled","true"),void(n.style.backgroundColor="#ccc");!horariosOcupados.some((({horaInicio:e,horaFin:a,estado:t})=>{if(2===t)return!1;const o=moment(e,"HH:mm"),n=moment(a,"HH:mm");return l.isBetween(o,n,null,"[)")||c.isBetween(o,n,null,"(]")||l.isBefore(o)&&c.isAfter(n)||l.isSameOrAfter(o)&&c.isSameOrBefore(n)}))?(n.addEventListener("click",(()=>seleccionarHoraPosponer(t))),n.style.backgroundColor="manana"===e?"#4caf50":"#e67e22"):(n.setAttribute("disabled","true"),n.style.backgroundColor="#ccc"),setTimeout((()=>{n.classList.add("visible")}),100*o),a.appendChild(n)})),citaAdmin.hora=null,toggleConfirmButton()}function seleccionarHoraPosponer(e){const a=document.querySelectorAll(".horario"),t=document.querySelector("#btn-confirmar");a.forEach((e=>e.classList.remove("seleccionado")));const o=Array.from(a).find((a=>a.textContent===e));if(o){if(o.classList.add("seleccionado"),citaAdmin.hora=e,citaAdmin.HoraOriginal&&citaAdmin.finalizacion){const a=moment(citaAdmin.HoraOriginal,"HH:mm"),t=moment(citaAdmin.finalizacion,"HH:mm"),o=moment.duration(t.diff(a)),n=moment(e,"HH:mm").clone().add(o);citaAdmin.horaFinal=n.format("HH:mm")}else citaAdmin.horaFinal=null;console.log("Nueva hora de inicio:",citaAdmin.hora),console.log("Nueva hora de finalización:",citaAdmin.horaFinal)}else citaAdmin.hora=null,citaAdmin.horaFinal=null;t.disabled=!citaAdmin.hora,console.log("Hora seleccionada:",citaAdmin.hora),console.log("Hora de finalización:",citaAdmin.horaFinal)}function validarObservacion(){const e=document.querySelector("#observacion-textarea"),a=document.querySelector("#enviar-observacion"),t=e.value.trim();a.disabled=t.length<15}function abrirModalObservaciones(){if(!citaAdmin.hora)return void console.error("No se puede abrir el modal: No hay hora seleccionada.");const e=document.querySelector("#modal-observaciones");e.style.display="block",e.classList.add("show");const a=document.querySelector("#observacion-textarea"),t=document.querySelector("#enviar-observacion");a.value="",t.disabled=!0}function cerrarModalObservaciones(){const e=document.querySelector("#modal-observaciones");e.style.display="none",e.classList.remove("show")}function enviarFecha(){const e=document.querySelector("#observacion-textarea").value.trim(),a=citaAdmin.fecha,t=citaAdmin.hora,o=citaAdmin.horaFinal,n=citaAdmin.id,r=citaAdmin.email,i=citaAdmin.usuarioId,l=document.getElementById("loading-spinner");e.length>=15&&a&&t&&o&&n?(l.classList.add("show"),fetch("/api/posponerFechaAdmin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({observacion:e,fecha:a,hora:t,horaFinal:o,citaid:n,usuarioId:i,email:r})}).then((e=>e.text())).then((e=>{console.log("Respuesta cruda del servidor:",e);try{const a=JSON.parse(e);console.log("Respuesta JSON:",a),a.resultado?(l.classList.remove("show"),Swal.fire({icon:"success",title:"Turno Pospuesto",text:"El turno fue pospuesto correctamente.",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):alert("Hubo un problema al posponer el turno: "+(a.error||"Error desconocido"))}catch(e){console.error("Error al parsear JSON:",e),alert("Hubo un error al procesar la respuesta del servidor.")}})).catch((e=>{console.error("Error al enviar los datos:",e),alert("Hubo un error al enviar los datos al servidor.")}))):alert("Por favor, completa todos los campos correctamente.")}citaAdmin.duracionTotal=duracionTotal,console.log(citaAdmin.duracionTotal);