let paso=1;const pasoInicial=1,pasoFinal=3,cita={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),confirmarServicioEdicion(),idCliente(),nombreCliente(),seleccionarFecha(),inicializarCalendario(),inicializarCalendarioEdicion(),configurarModales()}function agregarServicio(){const e=document.getElementById("modal-servicio-agregar");e.style.display="block",e.classList.remove("hide"),e.classList.add("show"),cerrarModalHistorial(),consultarAPIAgregar()}function cerrarModalAgregado(){document.getElementById("modal-servicio-agregar").style.display="none",abrirModalHistorial()}window.addEventListener("load",(()=>{"true"===sessionStorage.getItem("openModalHistorial")&&(abrirModalHistorial(),sessionStorage.removeItem("openModalHistorial"))})),document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));let esTurnoCompleto=!1;function anularCita(){const e=document.getElementById("modal-anular");e.classList.add("show"),e.style.display="block",cerrarModalHistorial(),cerrarModalEditarHistorial()}function cerrarModalAnular(){const e=document.getElementById("modal-anular");e.classList.remove("show"),setTimeout((()=>{e.style.display="none"}),400)}function anularServicio(){const e=cita.servicioIdAntiguo,o=cita.citaId;console.log("Servicio a anular:",e),console.log("id de la cita: ",o),esTurnoCompleto?(anularTurnoCompleto(o),cerrarModalEditarHistorial()):fetch("/api/anularservicio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioId:e,citaId:o})}).then((e=>e.json())).then((o=>{if(o.success){const o=document.querySelector(`[data-servicio-id="${e}"]`);o&&o.remove(),cerrarModalAnular(),cerrarModalEditarHistorial(),abrirModalHistorial()}else alert(o.message||"Hubo un error al anular el servicio. Inténtalo de nuevo.")})).catch((e=>{console.error("Error al intentar anular el servicio:",e),alert("Error en la solicitud. Inténtalo nuevamente."),document.querySelector(".loading-spinner").style.display="none"}))}function anularTurnoCompleto(e){const o=document.getElementById("loading-spinner");o.classList.add("show"),fetch("/api/anularturnocompleto",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({citaId:e})}).then((e=>e.json())).then((e=>{e.success?(o.classList.remove("show"),Swal.fire({icon:"success",title:"Turno Cancelado",text:"Tu turno fue cancelado correctamente",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):(alert(e.message||"Hubo un error al anular el turno. Inténtalo de nuevo."),document.querySelector(".loading-spinner").style.display="none")})).catch((e=>{console.error("Error al intentar anular el turno:",e),alert("Error en la solicitud. Inténtalo nuevamente."),document.querySelector(".loading-spinner").style.display="none"}))}function cerrarModalSeleccionEdicion(){const e=document.getElementById("modal-seleccion-edicion");e.classList.remove("show"),abrirModalEditarHistorial(),obtenerDetallesCita(),document.getElementById("blur-background3").style.display="none",document.getElementById("blur-background").style.display="none",setTimeout((()=>{e.style.display="none"}),300)}function cerrarModalFecha(){document.getElementById("modal-fecha").style.display="none",document.getElementById("blur-background").style.display="none",abrirModalEditarHistorial()}function filtrarServicios(){var e=document.getElementById("filtro-servicios").value,o=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("categoria-seleccionada").innerText=`Categoria seleccionada: ${o}`,document.querySelectorAll(".servicio").forEach((function(o){if("todos"===e)o.style.display="block";else{var a=o.getAttribute("data-categoria");o.style.display=a===e?"block":"none"}}))}function configurarModales(){const e=document.getElementById("modal"),o=document.getElementById("reservar-turno"),a=document.getElementById("cerrar-modal"),t=(document.getElementById("modal-seleccionar-turno"),document.getElementById("cerrar-modal-seleccionar"),document.getElementById("blur-background")),n=(document.getElementById("modal-blur-background"),document.getElementById("app")),i=document.querySelector(".barra");document.getElementById("dark-background");let r=window.innerWidth;o.addEventListener("click",(function(){consultarAPI(),r=window.innerWidth;const o=r-500;setTimeout((function(){calendar?(console.log("hola"),calendar.updateSize()):console.error("calendarAdmin no está inicializado.")}),300),n.style.width=`${o}px`,n.style.transition="width 0.5s",e.style.display="block",t.style.display="block",i.classList.add("modal-abierto"),document.body.style.overflow="hidden",e.classList.add("mostrar"),setTimeout((()=>{e.style.animation="slideIn 0.5s forwards"}),10)})),a.addEventListener("click",(function(){e.classList.remove("mostrar"),e.style.animation="slideOut 0.5s forwards",t.style.display="none",setTimeout((()=>{e.style.display="none",n.style.width=`${r}px`,i.classList.remove("modal-abierto"),document.body.style.overflow=""}),500)}))}function mostrarSeccion(){const e=document.querySelector(".seccion.mostrar");e&&e.classList.remove("mostrar");const o=`#paso-${paso}`;document.querySelector(o).classList.add("mostrar");const a=document.querySelector(".actual");a&&a.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual");document.querySelectorAll(".tabs button").forEach(((e,o)=>{o+1===paso?e.classList.remove("inactivo"):e.classList.add("inactivo")})),2===paso&&setTimeout((function(){console.log("Actualizando tamaño del calendario"),calendar&&calendar.updateSize()}),300)}function tabs(){document.querySelectorAll(".tabs button").forEach(((e,o)=>{e.classList.add("inactivo"),o+1===paso&&e.classList.remove("inactivo"),e.addEventListener("click",(function(e){e.preventDefault()}))}))}function botonesPaginador(){const e=document.querySelector("#anterior"),o=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),o.classList.remove("ocultar"),0===cita.servicios.length?o.disabled=!0:o.disabled=!1):3===paso?(e.classList.remove("ocultar"),o.classList.add("ocultar"),mostrarResumen()):2===paso?(e.classList.remove("ocultar"),o.classList.add("ocultar")):(e.classList.remove("ocultar"),o.classList.remove("ocultar")),mostrarSeccion()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",(function(){paso<=1||(paso--,botonesPaginador())}))}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",(function(){paso>=3||(paso++,botonesPaginador())}))}function mostrarServiciosAgregar(e){console.log("buenas",cita.servicioIdAntiguo);const o=document.querySelector("#servicios-edicion-agregar");o.innerHTML="";e.filter((e=>!cita.serviciosSacar.includes(e.id))).forEach((e=>{const{id:a,nombre:t,precio:n}=e,i=document.createElement("P");i.classList.add("nombre-servicio"),i.textContent=t;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=`$${n}`;const c=document.createElement("DIV");c.classList.add("servicio3"),c.dataset.idServicio=a,c.onclick=function(){seleccionarServicioAgregar(e)},c.appendChild(i),c.appendChild(r),o.appendChild(c)}))}function seleccionarServicioAgregar(e){const{id:o}=e,{servicios:a}=cita,t=document.querySelector(`#servicios-edicion-agregar [data-id-servicio="${o}"]`);a.some((e=>e.id===o))?(cita.servicios=a.filter((e=>e.id!==o)),t.classList.remove("seleccionado3")):(cita.servicios=[...a,e],t.classList.add("seleccionado3"));document.querySelector("#btn-confirmar-servicio-agregar").disabled=0===cita.servicios.length}function cerrarModalServicioAgregar(){document.getElementById("modal-servicio-agregar").style.display="none",abrirModalHistorial()}async function confirmarServicioAgregar(){const e=cita.servicios,o=cita.citaid;console.log("listado",e),console.log("citaid",o);const a=document.getElementById("loading-spinner");if(a.classList.add("show"),e.length>0)try{const a="/api/agregarServicio",t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({serviciosIds:e.map((e=>e.id)),citaId:o})});if(console.log(t),t.ok){console.log(t.ok);const e=t.headers.get("content-type");if(e&&e.includes("application/json")){const e=await t.json();console.log("Servicios actualizados:",e),e.resultado?Swal.fire({icon:"success",title:"Servicio Agregado",text:"Tu servicio fue agregado correctamente",button:"OK"}).then((()=>{sessionStorage.setItem("openModalHistorial","true"),setTimeout((()=>{window.location.reload()}),1e3)})):console.error("Error en la actualización:",e.error)}else console.error("Error: Respuesta no es JSON")}else console.error("Error al actualizar el servicio:",t.status)}catch(e){console.error("Error al enviar la solicitud:",e)}finally{a.classList.remove("show")}else console.error("No hay servicios seleccionados."),a.classList.remove("show")}function mostrarServiciosEdicion(e){const o=document.querySelector("#servicios-edicion");o.innerHTML="";e.filter((e=>e.duracion===cita.servicioEditable.duracion)).forEach((e=>{const{id:a,nombre:t,precio:n}=e;if(cita.servicioEditable&&cita.servicioEditable.nombre===t)return;const i=document.createElement("P");i.classList.add("nombre-servicio"),i.textContent=t;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=`$${n}`;const c=document.createElement("DIV");c.classList.add("servicio2"),c.dataset.idServicio=a,c.onclick=function(){seleccionarServicioEdicion(e)},c.appendChild(i),c.appendChild(r),o.appendChild(c)}))}function seleccionarServicioEdicion(e){const{id:o,nombre:a}=e,t=document.querySelector(`#servicios-edicion [data-id-servicio="${o}"]`);if(cita.servicioEditable){const e=document.querySelector(`#servicios-edicion [data-id-servicio="${cita.servicioEditable.id}"]`);e&&e.classList.remove("seleccionado")}cita.servicioEditable={id:o,nombre:a},t.classList.add("seleccionado");document.querySelector("#btn-confirmar-servicio").disabled=!cita.servicioEditable}async function confirmarServicioEdicion(){const e=cita.servicioEditable,o=cita.servicioIdAntiguo,a=cita.citaId;console.log(cita.servicioIdAntiguo);const t=document.getElementById("loading-spinner");if(t.classList.add("show"),e)try{const t="/api/actualizarservicioeditable",n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioIdAntiguo:o,servicioIdNuevo:e.id,citaId:a})});if(n.ok){const e=n.headers.get("content-type");if(e&&e.includes("application/json")){const e=await n.json();console.log("Servicio actualizado:",e),e.resultado?(cerrarModalServicio(),cerrarModalEditarHistorial(),cerrarModalSeleccion()):console.error("Error en la actualización:",e.error)}else console.error("Error: Respuesta no es JSON")}else console.error("Error al actualizar el servicio:",n.status)}catch(e){console.error("Error al enviar la solicitud:",e)}finally{t.classList.remove("show")}else t.classList.remove("show")}function cerrarModalSeleccion(){const e=document.getElementById("modal-seleccion-edicion");e.classList.remove("show"),setTimeout((()=>{e.style.display="none"}),300)}async function consultarAPIAgregar(){try{const e="/api/servicios-agregar",o=await fetch(e);mostrarServiciosAgregar(await o.json())}catch(e){console.log(e)}}async function consultarAPIEdicion(){try{const e="/api/servicios-edicion",o=await fetch(e);mostrarServiciosEdicion(await o.json())}catch(e){console.log(e)}}const categorias={cabello:["Full Diseño","Corte Clasico","Corte Moderno","Corte Infante"],facial:["Black Mask","Limpieza Facial Express","Tratamiento Anti-Edad"],combo:["Corte + Barba"],barba:["Recorte de Barba"]};function seleccionarServicio(e){const{id:o,nombre:a}=e;let{servicios:t}=cita;const n=document.querySelector(`#servicios [data-id-servicio="${o}"]`);if(t.some((e=>e.id===o)))cita.servicios=t.filter((e=>e.id!==o)),n.classList.remove("seleccionado"),a.toLowerCase().includes("corte infante")&&(cita.infanteSeleccionado=0,cita.cantidadInfantes=1,cita.observacionesInfante="");else{if(categorias.combo.includes(a)?(cita.servicios=[e],cita.infanteSeleccionado=0):a.toLowerCase().includes("corte infante")?(cita.servicios.push(e),cita.infanteSeleccionado=1,abrirModalInfante()):categorias.cabello.includes(a)?(cita.infanteSeleccionado||(cita.servicios=t.filter((e=>!categorias.cabello.includes(e.nombre)))),cita.servicios.push(e)):categorias.facial.includes(a)?(cita.servicios=t.filter((e=>!categorias.facial.includes(e.nombre))),cita.servicios.push(e)):(categorias.barba.includes(a),cita.servicios.push(e)),calcularDuracionServicios(),calcularPrecioTotal(),cita.duracionTotal>120)return Swal.fire({icon:"warning",title:"Límite alcanzado",text:"No puedes seleccionar más servicios, el tiempo máximo es de 2 horas.",confirmButtonColor:"#d33"}),cita.servicios=cita.servicios.filter((e=>e.id!==o)),n.classList.remove("seleccionado"),calcularDuracionServicios(),void calcularPrecioTotal();n.classList.add("seleccionado")}actualizarSeleccionVisual();document.querySelector("#siguiente").disabled=0===cita.servicios.length,console.log("Datos guardados en cita:",cita)}function actualizarPrecioPorCantidadInfantes(){calcularPrecioTotal(),calcularDuracionServicios()}function calcularPrecioTotal(){let e=0;cita.servicios.forEach((o=>{o.nombre.toLowerCase().includes("corte infante")?e+=parseFloat(o.precio)*(cita.cantidadInfantes||1):e+=parseFloat(o.precio)})),cita.precioTotal=e,console.log("Precio total de la cita:",cita.precioTotal)}function calcularDuracionServicios(){let e=0;cita.servicios.forEach((o=>{let a=parseInt(o.duracion,10);if(!isNaN(a))if(o.nombre.toLowerCase().includes("corte infante")){const o=cita.cantidadInfantes||1;e+=a*o}else e+=a})),cita.duracionTotal=e,console.log("Duración total de la cita:",cita.duracionTotal)}function abrirModalInfante(){console.log("Abriendo modal de infante...");const e=document.createElement("div");e.classList.add("modal-infante"),e.innerHTML='\n        <div class="modal-contenido">\n            <div class="modal-header">\n                <h2>Seleccionar Corte Infante</h2>\n                 <span  class="cerrar" onclick="cerrarModalInfante()">X</span>\n            </div>\n            <div class="modal-body">\n                <label for="cantidadInfantes">Cantidad de infantes:</label>\n                <input id="cantidadInfantes" type="number" min="1" max="4" value="1" class="input-estilizado">\n\n                <label for="detallesInfante">Detalles del infante (opcional):</label>\n                <textarea id="detallesInfante" maxlength="200" placeholder="Ejemplo: Tiene alergia a productos específicos..." class="textarea-estilizado"></textarea>\n                \n                <button id="confirmarCorteInfante" class="btn-confirmar">Confirmar</button>\n                <button class="btn-cancelar" onclick="cerrarModalInfante()">Cancelar</button>\n            </div>\n        </div>\n    ',document.body.appendChild(e),console.log("Modal de infante añadido al DOM");const o=document.getElementById("cantidadInfantes"),a=document.getElementById("detallesInfante");o.addEventListener("input",(()=>{let e=parseInt(o.value)||1;e=Math.max(1,Math.min(4,e)),o.value=e,cita.cantidadInfantes=e;const a=cita.servicios.find((e=>e.nombre.toLowerCase().includes("corte infante")));if(a){const o=parseInt(a.precio,10)||0;cita.precioTotal=o*e,console.log("Precio total recalculado: $",cita.precioTotal)}calcularDuracionServicios(),console.log("Duración total recalculada:",cita.duracionTotal),console.log("Cantidad de infantes seleccionada:",e)})),a.addEventListener("input",(()=>{""!==a.value.trim()?(cita.observacionesInfante=a.value,console.log("Detalles del infante ingresados:",a.value)):(cita.observacionesInfante="",console.log("No se ingresaron detalles del infante."))})),document.getElementById("confirmarCorteInfante").addEventListener("click",(()=>{console.log("Confirmando selección de Corte Infante..."),cita.observacionesInfante=a.value,cita.cantidadInfantes=parseInt(o.value)||1,actualizarPrecioPorCantidadInfantes(),console.log("Datos guardados en cita:",cita),cerrarModalInfante()})),e.style.display="block",console.log("Modal de infante mostrado en pantalla.")}function actualizarResumen(){console.log("Actualizando resumen...");const e=document.querySelector(".contenido-resumen p:nth-of-type(4)"),o=document.querySelector(".contenido-resumen p:nth-of-type(5)");let a=0;cita.servicios.forEach((e=>{let o=parseFloat(e.precio);if(e.nombre.toLowerCase().includes("corte infante")){const e=cita.cantidadInfantes;e&&(o*=parseInt(e,10))}a+=o})),e&&(e.innerHTML=`<span>Duración total:</span> ${cita.duracionTotal} minutos`,console.log("Duración total actualizada en el resumen:",cita.duracionTotal)),o&&(o.innerHTML=`<span>Total precio:</span> $${a.toFixed(2)}`,console.log("Precio total actualizado en el resumen: $",a.toFixed(2)))}function cerrarModalInfante(){const e=document.querySelector(".modal-infante");e&&(e.style.display="none",e.remove())}function actualizarSeleccionVisual(){document.querySelectorAll("#servicios .seleccionado").forEach((e=>{e.classList.remove("seleccionado")})),cita.servicios.forEach((e=>{const o=document.querySelector(`#servicios [data-id-servicio="${e.id}"]`);o&&o.classList.add("seleccionado")}))}function idCliente(){const e=document.querySelector("#id");console.log("Campo #id:",e),e?(cita.id=e.value,console.log("holaaaaaa",cita.id)):console.error("El campo #id no fue encontrado.")}function nombreCliente(){cita.nombre=document.querySelector("#nombre").value}var calendar2;function inicializarCalendarioEdicion(){var e=document.getElementById("calendar2"),o=document.getElementById("fecha"),a=document.getElementById("modal-seleccionar-turno-editar");document.querySelector("#modal");var t=new Date;t.setHours(0,0,0,0),new Date(t).setDate(t.getDate()+30);var n=new Date(t),i=new Date(t);i.setDate(t.getDate()+30);var r=new Date(t);r.setMonth(t.getMonth()+1),r.setDate(1),(calendar2=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",initialDate:t,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:n,end:i},dateClick:function(e){var t=new Date(e.dateStr);if(t.setHours(0,0,0,0),t<n||t>i)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const r=t.getUTCDay();[6].includes(r)||(e.dayEl.classList.add("selected"),o.value=e.dateStr,cita.fecha=e.dateStr,ConsultarHorarios(cita.fecha),a.style.display="block",a.classList.add("mostrar"),setTimeout((()=>{a.style.animation="slideIn 0.5s forwards"}),10),a.style.pointerEvents="auto"),[6].includes(r)&&(o.value="")},dayCellDidMount:function(e){var o=new Date(e.date);o.setHours(0,0,0,0),(o<n||o>i)&&e.el.classList.add("disabled-day"),o.getTime()===t.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const o=e.start.getMonth(),a=e.start.getFullYear(),n=new Date(t);n.setMonth(t.getMonth()+1),n.setFullYear(t.getFullYear());new Date(a,o,1);const i=o===t.getMonth()&&a===t.getFullYear(),r=o===n.getMonth()&&a===n.getFullYear();document.querySelector(".fc-prev-button").disabled=i;document.querySelector(".fc-next-button").disabled=r}})).render()}function editarFecha(){cerrarModalSeleccion();const e=document.getElementById("modal-fecha");e.classList.add("show"),e.style.display="block",setTimeout((function(){calendar2&&calendar2.updateSize()}),300)}function mostrarHorariosPosponer(e){const o=document.querySelector("#horarios-posponer");o.innerHTML="",o.style.display="flex";let a=[];const t=document.querySelector("#turno-manana"),n=document.querySelector("#turno-tarde");"manana"===e?(a=generarHorarios("08:00","11:30",30),t.classList.add("seleccionado"),n.classList.remove("seleccionado")):(a=generarHorarios("14:00","18:30",30),n.classList.add("seleccionado"),t.classList.remove("seleccionado")),a.forEach(((a,t)=>{const n=document.createElement("button");n.classList.add("botones","horario","botones-horarios","oculto"),n.textContent=a,n.style.backgroundColor="manana"===e?"#28a745":"#ff9800",n.addEventListener("click",(()=>seleccionarHoraPosponer(a))),setTimeout((()=>{n.classList.remove("oculto"),n.classList.add("visible")}),100*t),o.appendChild(n)}))}function mostrarHorariosEdicion(e){const o=document.querySelector("#horarios2");o.innerHTML="",o.style.display="block";let a=[];const t=document.querySelector("#turno-manana"),n=document.querySelector("#turno-tarde");let i;"manana"===e?(a=generarHorarios("08:00","11:30",30),t.classList.add("seleccionado"),n.classList.remove("seleccionado"),i=moment("12:00","HH:mm")):(a=generarHorarios("14:00","18:30",30),n.classList.add("seleccionado"),t.classList.remove("seleccionado"),i=moment("19:00","HH:mm"));const r=cita.duracionTotal;console.log("Duración total de la cita:",r),a.forEach(((a,t)=>{const n=document.createElement("BUTTON");n.classList.add("botones","horario","botones-horarios"),n.textContent=a;const c=moment(a,"HH:mm"),s=moment(a,"HH:mm").add(r,"minutes");if(s.isAfter(i))return n.setAttribute("disabled","true"),void(n.style.backgroundColor="#ccc");!horariosOcupados.some((({horaInicio:e,horaFin:o,estado:a})=>{if(2===a)return!1;const t=moment(e,"HH:mm"),n=moment(o,"HH:mm");return c.isBetween(t,n,null,"[)")||s.isBetween(t,n,null,"(]")||c.isBefore(t)&&s.isAfter(n)||c.isSameOrAfter(t)&&s.isSameOrBefore(n)}))?(n.addEventListener("click",(()=>seleccionarHoraEdicion(a))),n.style.backgroundColor="manana"===e?"#4caf50":"#e67e22"):(n.setAttribute("disabled","true"),n.style.backgroundColor="#ccc"),setTimeout((()=>{n.classList.add("visible")}),100*t),o.appendChild(n)})),cita.hora=null,toggleConfirmButton()}function seleccionarHoraEdicion(e){event.preventDefault();document.querySelector("#modal");const o=document.querySelectorAll(".horario");let a=document.querySelector("#cerrar-modal-seleccionar");const t=Array.from(o).find((o=>o.textContent===e));if(t)if(t.classList.contains("seleccionado")){console.log(`Deseleccionando la hora: ${e}`),t.classList.remove("seleccionado"),cita.hora=null,cita.horaFinal=null;Array.from(o).some((e=>e.classList.contains("seleccionado")))||(a.textContent="Cerrar",a.classList.remove("confirmar-seleccion"))}else{if(console.log(`Seleccionando la hora: ${e}`),o.forEach((e=>e.classList.remove("seleccionado"))),t.classList.add("seleccionado"),cita.hora=e,cita.horaOriginal&&cita.finalizacion){const o=moment(cita.horaOriginal,"HH:mm"),a=moment(cita.finalizacion,"HH:mm"),t=moment.duration(a.diff(o)),n=moment(e,"HH:mm").clone().add(t);cita.horaFinal=n.format("HH:mm")}else cita.horaFinal=null;console.log("Nueva hora de inicio:",cita.hora),console.log("Nueva hora de finalización:",cita.horaFinal),a.textContent="Confirmar",a.classList.add("confirmar-seleccion"),console.log("Asignando evento click a botonCerrar"),a.addEventListener("click",(function(){console.log("Evento click ejecutado");const e=document.getElementById("loading-spinner");if(e.classList.add("show"),cita.hora&&cita.fecha){console.log("Confirmando selección y enviando datos a la API...");const o=cita.citaid,a=cita.usuarioId;console.log(`Enviando Fecha: ${cita.fecha} y Hora: ${cita.hora}`,"cita: ",o,"usuario: ",a,"enviando finalizacion nueva:",cita.horaFinal),console.log("finalizacionnnn neuvaaaa: ",cita.horaFinal),fetch("/api/actualizarturno",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:cita.fecha,hora:cita.hora,horaFinal:cita.horaFinal,citaid:o,usuarioId:a})}).then((e=>{if(!e.ok)throw new Error("Error en la respuesta del servidor: "+e.statusText);return e.json()})).then((o=>{console.log("Respuesta del servidor:",o),o.resultado?(console.log("Cita actualizada exitosamente."),cerrarModalSecun(),document.querySelector("#modal-fecha").style.display="none",document.querySelector("#modal-seleccionar-turno-editar").style.display="none",document.querySelector("#blur-background").style.display="none",document.querySelector("#blur-background3").style.display="none",e.classList.remove("show"),abrirModalHistorial(),cita.fecha=null,cita.hora=null,cita.horaFinal=null):(console.error("Error en la actualización:",o.error),alert("Ocurrió un error: "+o.error))})).catch((e=>{console.error("Error al actualizar cita:",e.message),alert("Ocurrió un error al actualizar la cita: "+e.message)}))}else console.warn("Fecha o hora no seleccionadas. No se puede confirmar la cita."),alert("Por favor selecciona una fecha y una hora antes de confirmar.")}),{once:!0})}else console.warn(`Hora ${e} no encontrada en los botones de horario.`)}function abrirModalHistorial(){fetch("/api/historial-citas").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{const o=document.getElementById("historial-content");if(o.innerHTML="",document.getElementById("blur-background").style.display="block",e.success){const a=e.historial.filter((e=>2!==parseInt(e.estado)));if(0===a.length)o.innerText="No hay citas disponibles.";else{const e={};a.forEach((o=>{const a=`${o.fecha} ${o.hora.slice(0,5)}`;o.finalizacion.slice(0,5);e[a]||(e[a]=[]),e[a].push(o)})),Object.keys(e).forEach((a=>{const t=document.createElement("div");t.className="grupo-cita";const[n,i]=a.split(" "),r=e[a][0].finalizacion.slice(0,5);t.innerHTML=`\n                        <div class="info-fecha-hora">\n                            <div class="fecha-hora">\n                                <div><strong>Fecha:</strong> <span class="item">${n}</span></div>\n                                <div><strong>Hora:</strong> <span class="item">${i}</span></div>\n                                <div><strong>Finalización:</strong> <span class="item">${r}</span></div>\n                            </div>\n                            <div class="iconos-historial">\n                            <i class="fas fa-pencil-alt icono-lapiz" title="Posponer fecha" data-id="${a}"></i>\n                            <i class="fas fa-trash-alt icono-basura" title="Anular turno completo"></i>\n                            </div>\n                        </div>\n                    `;t.querySelector(".icono-lapiz").addEventListener("click",(function(){const o=e[a][0];console.log("Cita seleccionada:",o),cita.citaid=o.citaId,cita.usuarioId=o.usuarioId,cita.horaOriginal=o.hora.slice(0,5),cita.finalizacion=o.finalizacion.slice(0,5),cita.duracionTotal=o.duracionTotal??"No disponible",console.log("La cita es:",cita.citaid,"El usuario es:",cita.usuarioId,"La hora es:",cita.horaOriginal,"La finalización es:",cita.finalizacion,"La duración total es:",cita.duracionTotal),editarFecha()}));t.querySelector(".icono-basura").addEventListener("click",(function(){anularTurnoCompleto(e[a][0].citaId)})),e[a].forEach((e=>{const o=parseInt(e.servicioPrecio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0}),a=document.createElement("div");a.className="cita",a.setAttribute("data-id",e.servicioId),a.setAttribute("data-cita-id",e.citaId),a.innerHTML=`\n                            <div class="info">\n                                <div class="etiqueta">\n                                    <i class="fas fa-concierge-bell"></i> <strong>Servicio:</strong> <span class="item">${e.servicioNombre||"No especificado"}</span>\n                                </div>\n                            </div>\n                            <div class="precio-container">\n                                <span class="precio">${o}</span>\n                            </div>\n                        `,t.appendChild(a)})),1===e[a].length&&(esTurnoCompleto=!0,console.log(esTurnoCompleto)),o.appendChild(t)}))}}else o.innerText="No se pudo cargar el historial de citas."})).catch((e=>{document.getElementById("historial-content").innerText="Ocurrió un error al obtener el historial de citas.",console.error("Error:",e)}));const e=document.getElementById("modal-historial");e.style.display="block",setTimeout((()=>{e.classList.add("show")}),10)}function editarCita(){const e=document.getElementById("modal-seleccion-edicion");e.classList.add("show"),e.style.display="block",document.getElementById("blur-background3").style.display="none",cerrarModalEditarHistorial(),cerrarModalHistorial()}function cerrarModalHistorial(){const e=document.getElementById("modal-historial");e.classList.remove("show"),e.classList.add("hide"),document.getElementById("blur-background").style.display="none",setTimeout((()=>{e.style.display="none",e.classList.remove("hide")}),250)}function abrirModalEditarHistorial(e){console.log("ID del servicio:",e),cita.servicioIdAntiguo=e,fetch("/api/guardar-servicio-en-sesion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioId:e})}).then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{console.log(e),e.success?obtenerDetallesServicio():console.error(e.message||"No se pudo guardar el ID del servicio en la sesión")})).catch((e=>{console.error("Error:",e)}))}function obtenerDetallesServicio(){fetch("/api/historial-citas/detalles-servicio").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{console.log(e);const o=document.getElementById("editar-content");if(o.innerHTML="",e.success){const a=e.servicio,t=parseInt(a.precio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0});cita.servicioEditable={nombre:a.nombre,duracion:a.duracion},o.innerHTML=`\n                    <div class="etiqueta"><strong>Servicio:</strong> <span class="item">${a.nombre||"No especificado"}</span></div>\n                    <div class="etiqueta"><strong>Precio:</strong> <span class="item">${t}</span></div>\n                `;const n=document.getElementById("modal-editar-historial");n.classList.remove("hide"),n.classList.add("show"),n.style.display="block",cerrarModalHistorial(),document.getElementById("blur-background3").style.display="block"}else o.innerText="No se pudo cargar los detalles del servicio."})).catch((e=>{console.error("Error:",e),document.getElementById("editar-content").innerText="Ocurrió un error al obtener los detalles del servicio."}))}function obtenerDetallesCita(){fetch("/api/historial-citas/detalles").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{const o=document.getElementById("editar-content");if(o.innerHTML="",e.success){const o=e.cita;parseInt(o.servicioPrecio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0}),o.hora.slice(0,5);cita.servicioIdAntiguo=o.servicioId,cita.fechaAntigua=o.fecha,cita.id=o.citaId,console.log(cita.id)}else o.innerText="No se pudo cargar los detalles de la cita."})).catch((e=>{console.error("Error:",e),document.getElementById("editar-content").innerText="Ocurrió un error al obtener los detalles de la cita."}))}function cerrarModalEditarHistorial(){const e=document.getElementById("modal-editar-historial");document.getElementById("blur-background3").style.display="none",e.classList.remove("show"),e.classList.add("hide"),abrirModalHistorial(),setTimeout((()=>{e.style.display="none"}),300);document.querySelector("#servicios-edicion").querySelectorAll(".seleccionado").forEach((e=>{e.classList.remove("seleccionado")})),cita.servicioEditable=null;document.querySelector("#btn-confirmar-servicio").disabled=!0}let calendar;function inicializarCalendario(){var e=document.getElementById("calendar"),o=document.getElementById("fechaprincipal"),a=document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var t=new Date;t.setHours(0,0,0,0),new Date(t).setDate(t.getDate()+30);var n=new Date(t),i=new Date(t);i.setDate(t.getDate()+30),calendar=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",initialDate:t,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:n,end:i},dateClick:function(e){var t=new Date(e.dateStr);if(t.setHours(0,0,0,0),t<n||t>i)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const r=t.getUTCDay();[6].includes(r)||(e.dayEl.classList.add("selected"),o.value=e.dateStr,cita.fecha=e.dateStr,ConsultarHorarios(cita.fecha),a.style.display="block",a.classList.add("mostrar"),setTimeout((()=>{a.style.animation="slideIn 0.5s forwards"}),10),a.style.pointerEvents="auto"),[6].includes(r)&&(o.value="")},dayCellDidMount:function(e){var o=new Date(e.date);o.setHours(0,0,0,0),(o<n||o>i)&&e.el.classList.add("disabled-day"),o.getTime()===t.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const o=e.start.getMonth(),a=e.start.getFullYear(),n=new Date(t);n.setMonth(t.getMonth()+1),n.setFullYear(t.getFullYear());new Date(a,o,1);const i=o===t.getMonth()&&a===t.getFullYear(),r=o===n.getMonth()&&a===n.getFullYear();document.querySelector(".fc-prev-button").disabled=i;document.querySelector(".fc-next-button").disabled=r}}),calendar.render()}let horariosOcupados=[];function ConsultarHorarios(e){e?fetch("/api/consultarHorarios",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:e})}).then((e=>e.json())).then((e=>{e.error?alert("Error: "+e.error):(horariosOcupados=e.map((e=>({horaInicio:e.hora?e.hora.slice(0,5):"",horaFin:e.finalizacion?e.finalizacion.slice(0,5):"",estado:parseInt(e.estado,10)}))),console.log("Horarios ocupados:",horariosOcupados))})).catch((e=>{console.error("Error al obtener los horarios:",e)})):console.error("No se ha seleccionado una fecha válida.")}function mostrarHorarios(e){const o=document.querySelector("#horarios");o.innerHTML="",o.style.display="block";let a=[];const t=document.querySelector("#turno-manana"),n=document.querySelector("#turno-tarde");let i;"manana"===e?(a=generarHorarios("08:00","11:30",30),t.classList.add("seleccionado"),n.classList.remove("seleccionado"),i=moment("12:00","HH:mm")):(a=generarHorarios("14:00","18:30",30),n.classList.add("seleccionado"),t.classList.remove("seleccionado"),i=moment("19:00","HH:mm"));const r=cita.duracionTotal;console.log("Duración total de la cita:",r),a.forEach(((a,t)=>{const n=document.createElement("BUTTON");n.classList.add("botones","horario","botones-horarios"),n.textContent=a;const c=moment(a,"HH:mm"),s=moment(a,"HH:mm").add(r,"minutes");if(s.isAfter(i))return n.setAttribute("disabled","true"),void(n.style.backgroundColor="#ccc");!horariosOcupados.some((({horaInicio:e,horaFin:o,estado:a})=>{if(2===a)return!1;const t=moment(e,"HH:mm"),n=moment(o,"HH:mm");return c.isBetween(t,n,null,"[)")||s.isBetween(t,n,null,"(]")||c.isBefore(t)&&s.isAfter(n)||c.isSameOrAfter(t)&&s.isSameOrBefore(n)}))?(n.addEventListener("click",(()=>seleccionarHora(a))),n.style.backgroundColor="manana"===e?"#4caf50":"#ff9800"):(n.setAttribute("disabled","true"),n.style.backgroundColor="#ccc"),setTimeout((()=>{n.classList.add("visible")}),100*t),o.appendChild(n)})),cita.hora=null,toggleConfirmButton()}function generarHorarios(e,o,a){let t=[],n=moment(e,"HH:mm"),i=moment(o,"HH:mm");for(;n<=i;)t.push(n.format("HH:mm")),n.add(a,"minutes");return t}function toggleConfirmButton(){const e=document.getElementById("confirmar-modal-seleccionar");cita.hora?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}function seleccionarHora(e){const o=document.querySelectorAll(".horario"),a=(document.querySelector("#cerrar-modal-seleccionar"),Array.from(o).find((o=>o.textContent===e)));a&&(a.classList.contains("seleccionado")?(a.classList.remove("seleccionado"),cita.hora=null):(o.forEach((e=>e.classList.remove("seleccionado"))),a.classList.add("seleccionado"),cita.hora=e,console.log(cita.hora)),calcularFinalizacionPrevista(),toggleConfirmButton())}function confirmar(){if(cita.hora&&cita.fecha){if(cita.servicios&&cita.servicios.length>0)console.log("Creando nueva cita"),paso=3,console.log("Cita confirmada con servicios:",cita.servicios),botonesPaginador();else{const e=document.getElementById("loading-spinner");e.classList.add("show"),console.log("Posponiendo cita"),console.log(cita.fecha,cita.hora);const o=cita.citaid,a=cita.usuarioId;console.log(`Enviando Fecha: ${cita.fecha} y Hora: ${cita.hora}`,"cita: ",o,"usuario: ",a,"nueva finalizacion: ",cita.horaFinal),fetch("/api/actualizarturno",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:cita.fecha,hora:cita.hora,horaFinal:cita.horaFinal,citaid:o,usuarioId:a})}).then((e=>{if(!e.ok)throw new Error("Error en la respuesta del servidor: "+e.statusText);return e.json()})).then((o=>{console.log("Respuesta del servidor:",o),o.resultado?(console.log("Cita actualizada exitosamente."),document.querySelector("#modal-fecha").style.display="none",document.querySelector("#modal-seleccion-edicion").style.display="none",document.querySelector("#blur-background").style.display="none",document.querySelector("#blur-background3").style.display="none",e.classList.remove("show"),Swal.fire({title:"¡Cita Actualizada!",text:"Tu cita ha sido reprogramada exitosamente.",icon:"success",confirmButtonText:"Aceptar",timer:3e3,timerProgressBar:!0}).then((()=>{window.location.href="/cita"})),cita.fecha=null,cita.hora=null):(console.error("Error en la actualización:",o.error),Swal.fire({title:"Error",text:"Ocurrió un problema al actualizar la cita.",icon:"error",confirmButtonText:"Aceptar"}))})).catch((e=>{console.error("Error al actualizar cita:",e.message),Swal.fire({title:"Error",text:"Ocurrió un error al actualizar la cita: "+e.message,icon:"error",confirmButtonText:"Aceptar"})}))}cerrarModalSecundario()}else console.log("Faltan datos: Hora y fecha son necesarios"),Swal.fire({title:"Atención",text:"Debes seleccionar una fecha y una hora para confirmar la cita.",icon:"warning",confirmButtonText:"Aceptar"})}function cerrarModalSecun(){const e=document.getElementById("modal"),o=document.getElementById("modal-seleccionar-turno-editar"),a=document.querySelector(".dark-background"),t=document.getElementById("blur-background");o.style.animation="slideOut 0.5s forwards",o.style.pointerEvents="none",a.style.display="none",setTimeout((()=>{o.style.display="none",o.classList.remove("mostrar"),o.style.pointerEvents="none",e.style.pointerEvents="auto",t.style.display="block"}),500)}function cerrarModalSecundario(){const e=document.getElementById("modal"),o=document.getElementById("modal-seleccionar-turno"),a=document.querySelector(".dark-background"),t=document.getElementById("blur-background");o.style.animation="slideOut 0.5s forwards",o.style.pointerEvents="none",a.style.display="none",setTimeout((()=>{o.style.display="none",o.classList.remove("mostrar"),o.style.pointerEvents="none",cita.fecha&&mostrarHorarios(cita.turno||"manana"),e.style.pointerEvents="auto",t.style.display="block"}),500)}async function consultarHorariosOcupados(e){const o=`/api/horarios-ocupados?fecha=${e}`,a=await fetch(o),t=await a.json(),n=horarios.filter((e=>!t.includes(e)));mostrarHorariosDisponibles(n)}function seleccionarFecha(){document.querySelector("#fecha").addEventListener("input",(function(e){const o=new Date(e.target.value).getUTCDay();[6,0].includes(o)?(e.target.value="",mostrarAlerta("Fines de semana no permitidos","error",".formulario")):cita.fecha=e.target.value}))}function mostrarAlerta(e,o,a,t=!0){const n=document.querySelector(".alerta");n&&n.remove();const i=document.createElement("DIV");i.textContent=e,i.classList.add("alerta"),i.classList.add(o);document.querySelector(a).appendChild(i),t&&setTimeout((()=>{i.remove()}),3e3)}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");for(console.log("Cita actual:",cita);e.firstChild;)e.removeChild(e.firstChild);if(!cita.nombre||!cita.fecha||!cita.hora||0===cita.servicios.length)return void mostrarAlerta("Faltan datos de Servicios, Fecha u Hora","error",".contenido-resumen",!1);calcularFinalizacionPrevista();let o=0;cita.servicios.forEach((e=>{e.nombre.toLowerCase().includes("corte infante")?o+=parseFloat(e.precio)*cita.cantidadInfantes:o+=parseFloat(e.precio)}));const{nombre:a,fecha:t,hora:n,servicios:i}=cita,r=document.createElement("H3");r.textContent="Resumen de Servicios",e.appendChild(r);let c=!1;if(i.forEach((o=>{const{precio:a,nombre:t}=o,n=document.createElement("DIV");n.classList.add("contenedor-servicio");const i=document.createElement("P");i.textContent=t;const r=document.createElement("P");let s=a;t.toLowerCase().includes("corte infante")&&(s=(parseFloat(a)*cita.cantidadInfantes).toFixed(2)),r.innerHTML=`<span>Precio:</span> $${s}`,n.appendChild(i),n.appendChild(r),e.appendChild(n),t.toLowerCase().includes("corte infante")&&(c=!0)})),c){if(cita.cantidadInfantes>0){const o=document.createElement("P");o.innerHTML=`<span>Cantidad de infantes:</span> ${cita.cantidadInfantes}`,e.appendChild(o)}if(cita.observacionesInfante&&""!==cita.observacionesInfante.trim()){const o=document.createElement("P");o.innerHTML=`<span>Observaciones del infante:</span> ${cita.observacionesInfante}`,e.appendChild(o)}}const s=document.createElement("H3");s.textContent="Resumen de Cita",e.appendChild(s);const l=document.createElement("P");l.innerHTML=`<span>Nombre:</span> ${a}`;const d=new Date(t),u=d.getMonth(),m=d.getDate()+2,f=d.getFullYear(),p=new Date(Date.UTC(f,u,m)).toLocaleDateString("es-AR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),h=document.createElement("P");h.innerHTML=`<span>Fecha:</span> ${p}`;const v=document.createElement("P");v.innerHTML=`<span>Hora:</span> ${n} Horas`;const g=document.createElement("P");g.innerHTML=`<span>Duración total:</span> ${cita.duracionTotal} minutos`;const y=document.createElement("P");y.innerHTML=`<span>Finalización prevista:</span> ${cita.finalizacionPrevista}`;const b=document.createElement("P");b.innerHTML=`<span>Total precio:</span> $${o.toFixed(2)}`;const E=document.createElement("BUTTON");E.classList.add("boton"),E.textContent="Reservar Cita",E.onclick=reservarCita,e.appendChild(l),e.appendChild(h),e.appendChild(v),e.appendChild(g),e.appendChild(y),e.appendChild(b),e.appendChild(E)}function calcularFinalizacionPrevista(){if(!cita.hora||!cita.duracionTotal)return void console.warn("Faltan datos para calcular la finalización prevista.");let[e,o]=cita.hora.split(":").map(Number),a=new Date(cita.fecha+"T"+cita.hora+":00");a.setMinutes(a.getMinutes()+cita.duracionTotal);let t=a.getHours(),n=a.getMinutes();n%30!=0&&(n=30*Math.ceil(n/30),60===n&&(n=0,t+=1));let i=t.toString().padStart(2,"0"),r=n.toString().padStart(2,"0");cita.finalizacionPrevista=`${i}:${r}`,console.log("Finalización prevista redondeada:",cita.finalizacionPrevista)}async function reservarCita(){calcularFinalizacionPrevista();const{nombre:e,fecha:o,hora:a,servicios:t,id:n,duracionTotal:i,observacionesInfante:r,finalizacionPrevista:c}=cita;if(!o||!a||0===t.length)return void Swal.fire({icon:"warning",title:"Atención",text:"Debes seleccionar una fecha, una hora y al menos un servicio antes de reservar.",confirmButtonText:"Aceptar"});const s=t.map((e=>e.id)),l=document.getElementById("loading-spinner");l.classList.add("show");const d=new FormData;d.append("fecha",o),d.append("hora",a),d.append("usuarioId",n),d.append("servicios",s),d.append("duracionTotal",i),d.append("observacionesInfante",r||""),d.append("finalizacionPrevista",c),console.log([...d]);try{const e="/api/citas",o=await fetch(e,{method:"POST",body:d}),a=await o.json();console.log(a),a.resultado?Swal.fire({icon:"success",title:"Cita Creada",text:"Tu cita fue creada correctamente.",confirmButtonText:"Aceptar",timer:3e3,timerProgressBar:!0}).then((()=>{window.location.href="/cita"})):Swal.fire({icon:"error",title:"Error",text:"No se pudo crear la cita. Inténtalo de nuevo."})}catch(e){console.error("Error al reservar cita:",e),l.classList.remove("show"),Swal.fire({icon:"error",title:"Error",text:"Hubo un error al guardar la cita. Por favor, inténtalo de nuevo."})}}